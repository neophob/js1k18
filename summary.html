<!DOCTYPE html>
<html>
  <head>
    <title>JS Code Golf</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body {
        font-family: 'Droid Serif';
      }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: 400;
        margin-bottom: 0;
      }
      .remark-slide-content h1 { font-size: 3em; }
      .remark-slide-content h2 { font-size: 2em; }
      .remark-slide-content h3 { font-size: 1.6em; }
      .footnote {
        position: absolute;
        bottom: 3em;
      }
      li p { line-height: 1.25em; }
      .red { color: #fa0000; }
      .large { font-size: 2em; }
      a, a > code {
        color: rgb(249, 38, 114);
        text-decoration: none;
      }
      code {
        background: #e7e8e2;
        border-radius: 5px;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      .remark-code-line-highlighted     { background-color: #373832; }
      .pull-left {
        float: left;
        width: 47%;
      }
      .pull-right {
        float: right;
        width: 47%;
      }
      .pull-right ~ p {
        clear: both;
      }
      #slideshow .slide .content code {
        font-size: 0.8em;
      }
      #slideshow .slide .content pre code {
        font-size: 0.9em;
        padding: 15px;
      }
      .inverse {
        background: #272822;
        color: #777872;
        text-shadow: 0 0 20px #333;
      }
      .inverse h1, .inverse h2 {
        color: #f3f3f3;
        line-height: 0.8em;
      }

      /* Slide-specific styling */
      #slide-inverse .footnote {
        bottom: 12px;
        left: 20px;
      }
      #slide-how .slides {
        font-size: 0.9em;
        position: absolute;
        top:  151px;
        right: 140px;
      }
      #slide-how .slides h3 {
        margin-top: 0.2em;
      }
      #slide-how .slides .first, #slide-how .slides .second {
        padding: 1px 20px;
        height: 90px;
        width: 120px;
        -moz-box-shadow: 0 0 10px #777;
        -webkit-box-shadow: 0 0 10px #777;
        box-shadow: 0 0 10px #777;
      }
      #slide-how .slides .first {
        background: #fff;
        position: absolute;
        top: 20%;
        left: 20%;
        z-index: 1;
      }
      #slide-how .slides .second {
        position: relative;
        background: #fff;
        z-index: 0;
      }

      /* Two-column layout */
      .left-column {
        color: #777;
        width: 45%;
        height: 92%;
        float: left;
      }
      .left-column h2:last-of-type, .left-column h3:last-child {
        color: #000;
      }
      .right-column {
        width: 50%;
        float: right;
        padding-top: 1em;
      }
    </style>
  </head>
  <body>
    <textarea id="source">
name: inverse
layout: false
count: false
class: center, middle, inverse

# JS1k
2018 by Michael Vogt
.footnote[Go directly to [project site](https://github.com/neophob/js1k18)]

---

# Agenda

1. WHY?

1. Demo Time

1. Close look at my js1k compo entry

1. Toolchain

1. Tricks

---
class: center, middle, inverse

# WHY?

---
# WHY?

- Compo on js1k.com - 10th time this year

--

- Fun!

--

- Small Scope (my entry has about 170 lines, including comments)

--

- Think different

--

- Learn JS

---
class: center, middle, inverse

# Demo Time

---
# Demo Time

Some JS1k entries from the past I like.

--

### Canvas

- Pure javascript raytracer: ["pure js ray tracer" by Igor Sbitnev](http://js1k.com/2017-magic/demo/2648)

--

- Ride the mysterious monorail through a misty metropolis: ["Mysterious Monorail" by homecoded](http://js1k.com/2015-hypetrain/demo/2322)

--

### WebGL

- ["Romanesco 2.0" by Lara & HellMood](http://js1k.com/2016-elemental/demo/2552)

--

- ["Takoscript" by Shotgan & frikeldon](http://js1k.com/2017-magic/demo/2829)

---
class: center, middle, inverse

# My js1k compo entry

Full JS source of "Black Rock City":
```
for(_='],~102k~[k~[j=new ``Uint_++)^;b^\\let Z{ZY])*X(0|W);V+dTn[S;eRb)Q16P*eOO-Nat
L=0Kk5J(k3&H)]+SHfG)+J*HeFFTG-dFE<<$)$10)+H#2e6")/+=k4255=(DLe.now()*(-B8,for(Ze=),
ImageDLa(F-dGT|Wf[>eR.fill([b]bK,dK*MLh.random()X(1-h)Array;J>f;fQgSHf =MLh.sin(Xh+
Wg[]k<e&&Sb-1]<n?24a.height=[[j192,51,Pj]][We/51a.width)]4+4*b-1.5*b,Sf+JO]=>g?:<g?
:g;:)$240011$822$P,Z,e=8,f=,g`Buffer(*$2h_32(gi_8(gA=[~l=[~BK,m=c.creLe,n=(")0oQ=>{
if(1!=QYd=b/2;d;JQf=d  -dET0;Jd)feT)%b  FGEo(d)}};o(V;J>b\\{d=b%64?d:P$6;dR<d+64R^S
JO+b]=};">b\\if(!=b%J&&n)Ye=n/4,f+1)%5~g)%5~h=e%51/51;l[d7l[d+"0A[d++]=e}setInterva
l(()=>Yneoe+1.6Vb-=nd-=oe+(B=2e3(ff+A[(Hd#Q]2h(B%P?(gK,):(g=",f8,240))$24VZp=()VP;2
e3>e?1:4)YB=-oNnO,m=nNoO,DoNnNB,r-nNoNm;Bb,md;bK;b<\\YdHm#BiK|(f+192-A[dX/(4OVfor(;
i<p;p=i)iR<pR^h[e*+b]=l[gT];BD,mr}}m.dLa.set(ic.putm,0,0)},0)';G=/[^ !%-DIMU[\]a-il
-}]/.exec(_);)with(_.split(G))_=join(shift());eval(_)
```

["Black Rock City"](https://js1k.com/2018-coins/demo/3012)

---
# Step-by-Step "Black Rock City"

### Parts:

- Generate heightmap

--

- Colorize Map

--

- Voxel rendering

--

- Update camera path

--

- Generate some actions to be less boring

---

# Step-by-Step "Black Rock City"

### Heightmap

--

.left-column[
  .left[![](pics/heightmap.jpg)]
]

--
.right-column[
- "Diamond Square" algorithm based on http://www.playfuljs.com/realistic-terrain-in-130-lines/

- modified that generated heightmap is seamless / tileable

- optimized for size
]

---

# Step-by-Step "Black Rock City"

### Colorize map

--

.left-column[
  .left[![](pics/colormap.jpg)]
]

--
.right-column[
- Colorize the heightmap with a palette

- I use 5 colors in my map that fade into each other: black, red, orange (kind of), red, black

- Still does not look too fancy, peaks are not visible
]

---

# Step-by-Step "Black Rock City"

### Shadow map

--

.left-column[
  .left[![](pics/shadowmap.jpg)]
]

--
.right-column[
- Generate shadowmap so it looks more realistic

- Implementation is dead simple: `if (heightmap[n]>102 && heightmap[n-1] < heightmap[n]) increase alpha value`

- Shadows are only visible after a certain height (above the lava)
]

---

# Step-by-Step "Black Rock City"

### Map generation summary

Generate the realtime map is about 50% of the whole code (70 lines).

.center[![](pics/height-color-shadow.jpg)]


["Realtime Map Generation"](noise/index.html)


---

# Step-by-Step "Black Rock City"

### Voxel rendering

--

- "Voxel rendering" based on https://github.com/s-macke/VoxelSpace/

--

- About 30 lines of Code

--

- Size optimized, simplified LOD

--

.center[<img src="pics/fronttoback.gif" width="700" height="200" />]


.footnote[Image source [https://github.com/s-macke/VoxelSpace](https://github.com/s-macke/VoxelSpace)]

---

# Step-by-Step "Black Rock City"

### Camera path

.left-column[
  .left[![](pics/camerapath.jpg)]
]

--
.right-column[
- pretty boring, sinus / cosinus based on time

- camera angle depends on the current map height
]

---

# Step-by-Step "Black Rock City"

### Generate some actions to be less boring

--

- add black blocks to the generated map

--

- add random lightning, shakes camera and show fake light

--

.center[![](pics/lightning.jpg)]

---
class: center, middle, inverse

# Toolchain

---
# Toolchain

### Babel-minifier

This tool will shrink the codesize using

- remove whitespaces, uneeded characters and dead code

- mangle names:ÔΩõ `var positition` ‚ü∂ `var b` ÔΩù

- optimize numbers: ÔΩõ `20000` ‚ü∂ `2e4` ÔΩù

- constant folding: ÔΩõ `2 * 3` ‚ü∂ `6` ÔΩù

- reorder code to compress better with gzip

... and much more. **No** decompression is needed to run your JS code.

Similar Tools: uglifyJS, Google Closure Compiler, butternut

---

# Toolchain

### Regpack

This tool is a "Self-contained packer" to shrink the codesize.

- Made to compress small JS files (1-4kb)

- Has seven stages to optimize the code

- Decompress payload is 50 bytes (JSCrunch)

- Eliminate redundancies, replaced by tokens

- Core compression is a token based String replacment (JSCrunch)

- Regpack improves compression of JSCrunch and add more features

- To compare: gzip compress (best) compress roughly 30% better

---

# Toolchain

### Regpack Example (JSCrush)

In (163 bytes):
```
var a=1000000;
if (a==1000000) console.log('1 == 0');
if (a==1000000) console.log('2 == 0');
if (a!==0) console.log('1 > 0');
if (a!==0) console.log('2 > 0');
```

Out (141 bytes):
```
_="var az0}1 =={}2 =={;|1 >{; |2 >{;~0) console.log('}; y=z~|y!==~{ 0'
)z=100000yif (a";for(i of"yz{|}~")with(_.split(i))_=join(pop());eval(_)
```

---

# Toolchain

### Regpack Example (JSCrush)

More Readable output:

.center[![](pics/jscrush-init.png)]

- Char Tokens: `yz{|}~`

How the magic works:
1. `if (a` is removed from end of string and replace all `y` character
1. `=100000` is removed from end of string and replace all `z` characters

---

# Toolchain

### Regpack Example (JSCrush)

.center[![](pics/jscrush-step-by-step.png)]

---

# Toolchain

### Alternatives

- Use the PNG decompression of the browser (zlib)

- use HTMLCanvasElement.toDataURL to access decompressed data

- example: https://github.com/ShyykoSerhiy/canvas-png-compression

---
class: center, middle, inverse

# Tricks

---
# Tricks

### Convert float numbers to integer numbers

--

Instead ÔΩõ `Math.floor(x)` ÔΩùuseÔΩõ `x|0` ÔΩù


- Works only for 32bit (signed) integers
- *Note:* Differs from Math.floor for negative numbers

- Math.floor example: ÔΩõ `Math.floor(-1.8)` ‚ü∂ `-2` ÔΩù
- Bitwise OR example: ÔΩõ `-1.8|0` ‚ü∂ `-1` ÔΩù

--

Instead ÔΩõ `Math.floor(x/2)` ÔΩùuseÔΩõ `x>>1` ÔΩù


- Works only for 32bit (signed) integers
- Floats are converted to integers
- *Note:* Differs from Math.floor for negative numbers

- Math.floor example: ÔΩõ `Math.floor(15.5/2)` ‚ü∂ `7` ÔΩù
- Right shift example: ÔΩõ `15.5>>1` ‚ü∂ `7` ÔΩù


---

# Tricks

### Choose clever values

- Do you really need a `x > 100`? maybe a `x > 99` works too?

--

- InsteadÔΩõ `var a = Math.sin(value); var b = Math.cos(value);` ÔΩù useÔΩõ `var a = Math.sin(value); var b = Math.sin(value + 1.6);` ÔΩù

---

# Tricks

### Tradeoff Memory vs. Size

--

- InsteadÔΩõ `var a = new Array(1024*1024)` ÔΩùuseÔΩõ `var a = Array(2e6)` ÔΩù

---

# Tricks

### Mechanized Abbreviation

"Invented" by Marijn Haverbeke for JS1k compo in 2010.

```
for($ in C=c.getContext('2d'))
  C[$[0]+($[6]||'')]=C[$];
```

--

We now have:
- `C.qt` for `quadraticCurveTo`
- `C.f` for `fill`.


Note:
- Don't do this yourself, Regpack can do that for you (Module "hash contexts")


---

# Tricks

### Duplicate code

- Regpack will detect duplicate code and eliminite it

- try to use that, duplicated code is cheap!

- not always that easy when babel-minifier runs

Example code (calculate color palette):

```
let col1 = [[], [0x60], [0x90,0x30,0x10], [0x60],[]][ (1+(heightMapEntry/(255 / 5))|0)%5];
let col2 = [[], [0x60], [0x90,0x30,0x10], [0x60],[]][    (heightMapEntry/(255 / 5) |0)%5];
```

---
class: center, middle, inverse

# EOF

    </textarea>
    <script src="remark/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create();
    </script>
  </body>
</html>
