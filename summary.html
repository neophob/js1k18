<!DOCTYPE html>
<html>
  <head>
    <title>JS Code Golf</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body {
        font-family: 'Droid Serif';
      }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: 400;
        margin-bottom: 0;
      }
      .remark-slide-content h1 { font-size: 3em; }
      .remark-slide-content h2 { font-size: 2em; }
      .remark-slide-content h3 { font-size: 1.6em; }
      .footnote {
        position: absolute;
        bottom: 3em;
      }
      li p { line-height: 1.25em; }
      .red { color: #fa0000; }
      .large { font-size: 2em; }
      a, a > code {
        color: rgb(249, 38, 114);
        text-decoration: none;
      }
      code {
        background: #e7e8e2;
        border-radius: 5px;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      .remark-code-line-highlighted     { background-color: #373832; }
      .pull-left {
        float: left;
        width: 47%;
      }
      .pull-right {
        float: right;
        width: 47%;
      }
      .pull-right ~ p {
        clear: both;
      }
      #slideshow .slide .content code {
        font-size: 0.8em;
      }
      #slideshow .slide .content pre code {
        font-size: 0.9em;
        padding: 15px;
      }
      .inverse {
        background: #272822;
        color: #777872;
        text-shadow: 0 0 20px #333;
      }
      .inverse h1, .inverse h2 {
        color: #f3f3f3;
        line-height: 0.8em;
      }

      /* Slide-specific styling */
      #slide-inverse .footnote {
        bottom: 12px;
        left: 20px;
      }
      #slide-how .slides {
        font-size: 0.9em;
        position: absolute;
        top:  151px;
        right: 140px;
      }
      #slide-how .slides h3 {
        margin-top: 0.2em;
      }
      #slide-how .slides .first, #slide-how .slides .second {
        padding: 1px 20px;
        height: 90px;
        width: 120px;
        -moz-box-shadow: 0 0 10px #777;
        -webkit-box-shadow: 0 0 10px #777;
        box-shadow: 0 0 10px #777;
      }
      #slide-how .slides .first {
        background: #fff;
        position: absolute;
        top: 20%;
        left: 20%;
        z-index: 1;
      }
      #slide-how .slides .second {
        position: relative;
        background: #fff;
        z-index: 0;
      }

      /* Two-column layout */
      .left-column {
        color: #777;
        width: 45%;
        height: 92%;
        float: left;
      }
      .left-column h2:last-of-type, .left-column h3:last-child {
        color: #000;
      }
      .right-column {
        width: 50%;
        float: right;
        padding-top: 1em;
      }
    </style>
  </head>
  <body>
    <textarea id="source">
name: inverse
layout: false
class: center, middle, inverse

# JS1k - code golfing
2018 by Michael Vogt
.footnote[Go directly to [project site](https://github.com/neophob/js1k18)]

???
- Intro Speaker

- topic of this talk is "JS1k - code golfing"

- the goal of this talk is, show what you can do with 1k of pure js code, without any external assets

- lets jump to the agenda
---

# Agenda

1. WHY?

???

- first I will answer the obious WHY question

--

1. Demo Time

???

- then I will show you some 1k demos I like

--

1. Close look at my 1k production

???

- I will show you my 1k production and talk about how i build it

--

1. Toolchain

???

- Next, I will show you how to shrink the codesize

--

1. Tricks

???

- Some tricks I used to shrink the codesize

---
class: center, middle, inverse

# WHY?

---
# WHY?

- Yearly compo on js1k.com

???
- The compo started as joke, its the 10th compo this year

--

- Fun!

???
- at least I enjoy it, its completly different that a business project, you're allowed or forced to produce ugly looking code, pollute the global scope etc. any you can create something beautiful. and there's the competition

--

- Small Scope

???
- you have one file, my production has about 170 lines, including comments

--

- Think different

???
- today if you need to solve a problem, you often add a package to your project to solve a problem. sometimes thats not needed and you can solve the problem by using the brain

--

- Learn JS

???
- you learn JS, because you need to be creative.

---
class: center, middle, inverse

# Demo Time

???

I want to show you whats possible with 1k of JS code

---
# Demo Time

Some JS1k entries from the past I like.

???
js1k entries can use Canvas or WebGL

--

### Canvas

- Ride the mysterious monorail through a misty metropolis: ["Mysterious Monorail" by homecoded](http://js1k.com/2015-hypetrain/demo/2322)

--

### WebGL

- ["Romanesco 2.0" by Lara & HellMood](http://js1k.com/2016-elemental/demo/2552)

---
class: center, middle, inverse

# My js1k compo entry

Full JS source of "Black Rock City":
```
for(_='],~102k~[k~[j=new ``Uint_++)^;b^\\let Z{ZY])*X(0|W);V+dTn[S;eRb)Q16P*eOO-Nat
L=0Kk5J(k3&H)]+SHfG)+J*HeFFTG-dFE<<$)$10)+H#2e6")/+=k4255=(DLe.now()*(-B8,for(Ze=),
ImageDLa(F-dGT|Wf[>eR.fill([b]bK,dK*MLh.random()X(1-h)Array;J>f;fQgSHf =MLh.sin(Xh+
Wg[]k<e&&Sb-1]<n?24a.height=[[j192,51,Pj]][We/51a.width)]4+4*b-1.5*b,Sf+JO]=>g?:<g?
:g;:)$240011$822$P,Z,e=8,f=,g`Buffer(*$2h_32(gi_8(gA=[~l=[~BK,m=c.creLe,n=(")0oQ=>{
if(1!=QYd=b/2;d;JQf=d  -dET0;Jd)feT)%b  FGEo(d)}};o(V;J>b\\{d=b%64?d:P$6;dR<d+64R^S
JO+b]=};">b\\if(!=b%J&&n)Ye=n/4,f+1)%5~g)%5~h=e%51/51;l[d7l[d+"0A[d++]=e}setInterva
l(()=>Yneoe+1.6Vb-=nd-=oe+(B=2e3(ff+A[(Hd#Q]2h(B%P?(gK,):(g=",f8,240))$24VZp=()VP;2
e3>e?1:4)YB=-oNnO,m=nNoO,DoNnNB,r-nNoNm;Bb,md;bK;b<\\YdHm#BiK|(f+192-A[dX/(4OVfor(;
i<p;p=i)iR<pR^h[e*+b]=l[gT];BD,mr}}m.dLa.set(ic.putm,0,0)},0)';G=/[^ !%-DIMU[\]a-il
-}]/.exec(_);)with(_.split(G))_=join(shift());eval(_)
```

???

- thats exactly 1024 bytes of valid JS code
- the js1k.com compo is still running and ends this month.

--

["Black Rock City"](https://js1k.com/2018-coins/demo/3012)


???

- its a bit mean to show you my entry after the, in my humble opinion, best demos, nevermind here it is.

---
# Close look at "Black Rock City"

### Parts:

.left-column[
  .left[![](pics/blackrockcity.jpg)]
]

???

"Black Rock City" can be split up in different parts:

--

- Generate the map

???

- we need to define the height of the landscape
- we need to colorize this map

--

- Rendering

???

- I use a Voxel rendering

--

- Update camera path

???

- its bascially how we fly through this landscape

--

- Generate some actions to be less boring

---

# Close look at "Black Rock City"

### Generate the Map - Heightmap

???

- the heightmap is the foundation of the landscape

- how does a heightmap look like?

--

.left-column[
  .left[![](pics/heightmap.jpg)]
]

???

- its 1024 pixel wide and height array, contains 8 bit values
- 0 is the lowest point, 255 is highest point

--
.right-column[
- "Diamond Square" algorithm based on http://www.playfuljs.com/realistic-terrain-in-130-lines/

- modified that generated heightmap is seamless / tileable

- optimized for size
]

???

- next step: we need colors!

---

# Close look at "Black Rock City"

### Generate the Map - Colorize map

???

- as i want to display some lava-ish landscape I mainly focus on red and black colors.
- nice sideeffect: this colors use not much space when define the colors

--

.left-column[
  .left[![](pics/colormap.jpg)]
]

--
.right-column[
- Colorize the heightmap with a palette

- I use 5 colors in my map that fade into each other: black, red, orange (kind of), red, black
]

???

- looks a bit like a lava landscape, but still does not look too fancy, high mountains are not visible
- to solve that problem, I NEED SHADOWS


---

# Close look at "Black Rock City"

### Generate the Map - Shadow map

.left-column[
  .left[![](pics/shadowmap.jpg)]
]

???
- I started reading tutorials about generating shadows
- way too complex for my use case - i dont care where the sun is, all i want is shadow
- thats what I meant when I talked about "think different"

--
.right-column[
- Generate shadowmap so it looks more realistic

- Implementation is dead simple: `if (heightmap[n]>102 && heightmap[n-1] < heightmap[n]) increase alpha value`
]

???

- Shadows are only visible after a certain height (above the lava)

---

# Close look at "Black Rock City"

### Generate the Map - Summary

.center[![](pics/height-color-shadow.jpg)]


["Realtime Map Generation"](noise/index.html)

???
- Generate the realtime map is about 50% of the whole code (70 lines).
- Press on link to show different generated maps
- The landscape exists now, next step: visualize it
---

# Close look at "Black Rock City"

### Voxel rendering

???
- people in this room with greyish hair might remember comanche

- a game released by novalogic in 1992 and was quite a thing back then

--

- "Voxel rendering" based on https://github.com/s-macke/VoxelSpace/

--

- Size optimized, simplified LOD

--

- About 30 lines of Code

--

.center[<img src="pics/fronttoback.gif" width="700" height="200" />]


.footnote[Image source [https://github.com/s-macke/VoxelSpace](https://github.com/s-macke/VoxelSpace)]

???

- the image explains very well, how voxel rendering works
- landscape rendering is done too - now we need to move

---

# Close look at "Black Rock City"

### Camera path

.left-column[
  .left[![](pics/camerapath.jpg)]
]

--
.right-column[
- main animation is based on simple sinus calculation

- camera angle depends on the current map height -> path is different for each terrain
]

???

- next step: make rendering less boring

---

# Close look at "Black Rock City"

### Generate some actions to be less boring

--

- add black blocks to the generated map

--

- add lightning: shakes camera and show fake light

--

.center[![](pics/lightning.jpg)]

???

- the lightning is a bit subtile, the left side you see a regular rendering, on the right side the ligthning mode

- Now all the parts of the demo are here, however the JS code is about 6kb

---
class: center, middle, inverse

# Toolchain

???

- Of course the final asset I showed you before is not made manually

- Here I show you the toolchain I used

---
# Toolchain

### Babel-minifier

This tool will shrink the codesize using different plugins
- mangle names:ï½› `var positition` âŸ¶ `var b` ï½
- optimize numbers: ï½› `20000` âŸ¶ `2e4` ï½
- constant folding: ï½› `2 * 3` âŸ¶ `6` ï½
- reorder code to compress better with gzip

... and much more. **No** decompression is needed to run your JS code.

???

- remove whitespaces, uneeded characters and dead code

- Similar Tools: uglifyJS, Google Closure Compiler, butternut

- babel-minifier reduce the js size from about 6k to 2k

---

# Toolchain

### Regpack

This tool is a "Self-contained packer" to shrink the codesize.

- Core compression is a token based String replacment (JSCrunch)
- Regpack improves compression of JSCrunch and add more features
- To compare: gzip compress (best) compress roughly 30% better

**Decompression** (at runtime) is needed to run your JS code.

???

- Regpack has seven stages to optimize the code

- Decompress payload is 50 bytes (JSCrunch)

- Made to compress small JS files (1-4kb)

- We will take a look how JSCrunch works in the next slide

- for my entry, regpack reduce the size from 1771 bytes to 1024 bytes

---

# Toolchain

### Regpack Example (JSCrush)

In (163 bytes):
```
var a=1000000;
if (a==1000000) console.log('1 == 0');
if (a==1000000) console.log('2 == 0');
if (a!==0) console.log('1 > 0');
if (a!==0) console.log('2 > 0');
```

Out (141 bytes):
```
_="var az0}1 =={}2 =={;|1 >{; |2 >{;~0) console.log('}; y=z~|y!==~{ 0'
)z=100000yif (a";for(i of"yz{|}~")with(_.split(i))_=join(pop());eval(_)
```

???
- Here we compressed a short example. the compression rate is better if you have more code

---

# Toolchain

### Regpack Example (JSCrush)

More Readable output:

.center[![](pics/jscrush-init.png)]

- Char Tokens: `yz{|}~`

How the magic works:
1. `if (a` is removed from end of string and replace all `y` character
1. `=100000` is removed from end of string and replace all `z` characters

???

Here is the crunched code a bit reformated, see the colorized tokens
---

# Toolchain

### Regpack Example (JSCrush)

.center[![](pics/jscrush-step-by-step.png)]

???

- Step by step we decompress the input string

- the order of the tokens is important

---

# Toolchain

### Alternatives

- Use the PNG decompression of the browser (zlib)

- use HTMLCanvasElement.toDataURL to access decompressed data

- example: https://github.com/ShyykoSerhiy/canvas-png-compression

---
class: center, middle, inverse

# Tricks

---
# Tricks

### Convert float numbers to integer numbers

--

Instead ï½› `Math.floor(x)` ï½useï½› `x|0` ï½

- Works only for 32bit (signed) integers
- *Note:* Differs from Math.floor for negative numbers

Examples:
- Math.floor: ï½› `Math.floor(-1.8)` âŸ¶ `-2` ï½
- Bitwise OR: ï½› `-1.8|0` âŸ¶ `-1` ï½

--

Instead ï½› `Math.floor(x/2)` ï½useï½› `x>>1` ï½

- Works only for 32bit (signed) integers
- Floats are converted to integers
- *Note:* Differs from Math.floor for negative numbers

---

# Tricks

### Choose clever values

- Do you really need a `x > 100`? maybe a `x > 99` works too?

--

- Insteadï½› `var a = Math.sin(value); var b = Math.cos(value);` ï½ useï½› `var a = Math.sin(value); var b = Math.sin(value + 1.6);` ï½

???

- First example is simple from a technical view

- the second example will improve the compression rate with regpack

---

# Tricks

### Tradeoff Memory vs. Size

--

- Insteadï½› `let a = new Array(1024*1024)` ï½useï½› `let a = Array(2e6)` ï½

???

- I use this tradeoff in my code
- note that babel minify would do a constant folding on the multiplication, the string would be 2 characters shorter but will compress badly (1'048'576)

---

# Tricks

### Mechanized Abbreviation

"Invented" by Marijn Haverbeke for JS1k compo in 2010.

```
let canvas = document.createElement('canvas');
let context = canvas.getContext('2d');
for($ in C=context)
  C[$[0]+($[6]||'')]=C[$];
```

???
- any idea what this code snipped does?

--

#### Examples:
- `C.fx()` points to `context.fillText()`
- `C.f()` for `context.fill()`.

#### Note:
- Don't do this yourself, Regpack can do that for you (module "hash contexts")

???
- usefull if your code uses a lot of different canvas API calls
- especially the HTML5 audio API has a lot of long function names

---

# Tricks

### Question

What does this code do?

```
let value = [[], [0x60], [0x90,0x30,0x10], [0x60],[]] [ (heightMapEntry/(255 / 5)|0)
let r = value[0]|0;
let g = value[1]|0;
let b = value[2]|0;
```

???

- anybody have an idea what this code does?
- this code creates the pallette to colorize the map
- we have 5 colors, the black color does not need to be defined
- `undefined|0` -> `0`
---

# Tricks

### Duplicate code

- Regpack will detect duplicate code and eliminite it

- try to use that, duplicated code is cheap!

- not always that easy when babel-minifier runs

#### Example code (calculate color palette):

```
let col1 = [[], [0x60], [0x90,0x30,0x10], [0x60],[]][ (1+(heightMapEntry/(255 / 5))|0)%5];
let col2 = [[], [0x60], [0x90,0x30,0x10], [0x60],[]][    (heightMapEntry/(255 / 5) |0)%5];
```

???
- this code compress really well

---
class: center, middle, inverse

# EOF

???

- If you're interessted in realtime generated animations, don't hesitate to visit the Demonights event in the Effinger, there are about 4 Demonights per year

    </textarea>
    <script src="remark/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create({
        navigation: {
          scroll: false
        },
        slideNumberFormat: '',
      });
    </script>
  </body>
</html>
